<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="style.css">
    <title>GapSeeker!</title>
  </head>
  <body>
    <h1>Help you find a gap.</h1>
            <strong> Target Exchange</strong>
	    <input type="checkbox" onclick="toggle_exchanges()"\> Select All
	    <input type="checkbox" onclick="sh_exchanges()"\> Show/Hide
    <br>
    <div id="exchange"> </div>
    <br>
            <strong>Base Currency </strong>
    <br>
    <div id="base">
      <input type="checkbox" name="base" value=btc > <b>btc</b></input>
      <input type="checkbox" name="base" value=eth > <b>eth</b></input>
      <input type="checkbox" name="base" value=usdt > <b>usdt</b></input>
    </div>
    <br>
            <strong>Quote Currency </strong>
	    <input type="checkbox" onclick="toggle_coins()"\> Select All
            <input type="checkbox" onclick="sh_coins()"\> Show/Hide
    <br>
    <br>
    <div id="coins"> </div>
    <br>
    <form name="form3">
      <strong>Duration:</strong> <input type="text" id="duration" value="1" /> Hour <br>
      <strong>HttpTimOut:</strong> <input type="text" id="timeout" value="1"/> Second <br>
      <strong>Minimum Gap:</strong> <input type="text" id="gap" value="0.2"/> % <br>
      <strong>Minimum Amount:</strong> <input type="text" id="amount" value="1"/> <br>
    </form>
    <button onclick="run()" class="fa fa-pencil-square-o" data-dismiss="alert">Run</button>
    <button onclick="stop()" class="fa fa-pencil-square-o" data-dismiss="alert">Stop</button>

    <!-- Tab links -->
    <div class="tab">
      <button class="tablinks" style="display:none" onclick="openCity(event, 'London')">Order in count</button>
      <button class="tablinks" style="display:none" onclick="openCity(event, 'Paris')">Order in gap</button>
      <button class="tablinks" style="display:none" onclick="openCity(event, 'Tokyo')">Order in amount</button>
    </div>
    
    <!-- Tab content -->
    <textarea id="London" class="tabcontent" cols="90" rows="30" >
    </textarea>
    
    <textarea id="Paris" class="tabcontent" cols="90" rows="30" >
    </textarea>
    
    <textarea id="Tokyo" class="tabcontent" cols="90" rows="30" >
    </textarea>

    <div>
      <textarea id="output" cols="90" rows="30" class="form-control"></textarea>
    </div>

    <script>
      // You can also require other files to run in this process
      require('./renderer.js')
      const {ipcRenderer, clipboard} = require('electron')
      var child = null
      var order_gap_start = -1, order_count_start = -1, order_amount_start = -1

      function run() {
          if (this.child != null) {
              document.getElementById("output").innerHTML += "Still running";
              return
          }

	  // get exchanges
	  ex_obj = document.getElementsByName("ex");
	  exs = []
	  for (k in ex_obj) {
	    if (ex_obj[k].checked) {
	        exs.push(ex_obj[k].value)
	    }
	  }

	  if (exs.length < 2) {
            document.getElementById("output").innerHTML = "At least two exchanges\n";
            return
	  }

	  // get base
	  base_obj = document.getElementsByName("base");
	  base = []
	  for (k in base_obj) {
	    if (base_obj[k].checked) {
	        base.push(base_obj[k].value)
	    }
	  }

	  if (base.length < 1) {
            document.getElementById("output").innerHTML = "At least one base currency\n";
            return
	  }

	  // get coins
	  coin_obj = document.getElementsByName("coin");
	  coins = []
	  for (k in coin_obj) {
	    if (coin_obj[k].checked) {
	        coins.push(coin_obj[k].value)
	    }
	  }

	  if (base.length == 1 && coins.length == 0) {
            document.getElementById("output").innerHTML = "At least one quote currency\n";
            return
	  }

	  // get duration, timeout, gap, amount
	  duration = document.getElementById("duration");
	  timeout = document.getElementById("timeout");
	  gap = document.getElementById("gap");
	  amount = document.getElementById("amount");
	  if (duration.value.length == 0 || timeout.value.length == 0
		 || gap.value.length == 0 || amount.value.length == 0) {
              document.getElementById("output").innerHTML += "Please Specify Duration|Gap|Amount\n";
	      return;
	  }

          path = ipcRenderer.sendSync('get-path')
          if ( process.platform === 'win32' ) {
              command = 'find_gap';
          }  else if (process.platform === 'darwin') {
              command = './find_gap';
          }
          var spawn = require('child_process').spawn,
              child = spawn(command, ['run',exs.join(' '), base.join(' '), coins.join(' '),
		      duration.value, timeout.value, gap.value, amount.value],
		      {cwd: path});

          document.getElementById("output").innerHTML = "Starting...\n";
	  hideTab()
          order_gap_start = -1, order_count_start = -1, order_amount_start = -1
          this.child = child;
          child.stdout.on('data', function (data) {
              obj = document.getElementById("output")
              obj.innerHTML += data;
              obj.scrollTop = obj.scrollHeight;
              if (order_count_start == -1) {
	          order_count_start = data.toString().search("Order in count")
	      }
              if (order_gap_start == -1) {
	          order_gap_start = data.toString().search("Order in gap")
	      }
              if (order_amount_start == -1) {
	          order_amount_start = data.toString().search("Order in amount")
	      }

              if (order_count_start != -1 && order_gap_start != -1 && 
	          order_amount_start != -1) {
                  displayTab()
                  console.log(order_count_start)
                  console.log(order_gap_start)
                  console.log(order_amount_start)
                  tabcontent = document.getElementsByClassName("tabcontent");
		  tabcontent[0].innerHTML =
			      data.toString().substring(order_count_start + 15,
				      order_gap_start - 5)
		  tabcontent[1].innerHTML =
			      data.toString().substring(order_gap_start + 13,
				      order_amount_start - 5)
		  tabcontent[2].innerHTML =
			      data.toString().substring(order_amount_start + 16)
	      }
          });
          child.stderr.on('data', function (data) {
              document.getElementById("output").innerHTML += data;
          });
          child.on('exit', function (data) {
              document.getElementById("output").innerHTML += "\nStopped";
              this.child = null;
          });
      }

      function stop() {
          if (child == null) {
              document.getElementById("output").innerHTML += "\nAlready Stopped";
          } else {
              child.kill();
              child = null;
          }
      }

      function draw_exchanges(path) {
	  // get exchanges
          var spawn = require('child_process').spawnSync,
              child = spawn(command, ["exchanges"], {cwd: path});

	  exs = child.stdout.toString().replace(/\n$/, '').split(" ")
	  console.log(exs)

	  // draw exchanges
          exchange = document.getElementById('exchange');
          ex_div = document.createElement('div');
          ex_html = ""
	  //exs = ["bigone", "binance", "bitfinex", "huobi", "okex"]
	  for (i in exs) {
              ex_html +=  "<input type=\"checkbox\" name=\"ex\" value=\""+exs[i]+"\"> " + exs[i];
	  }
          ex_div.innerHTML = ex_html
          exchange.appendChild(ex_div);
      }

      function toggle_exchanges() {
          exchange = document.getElementById('exchange');
          div = exchange.children[0];
          for (i = 0; i < div.childElementCount; i++) {
              div.children[i].checked = !div.children[i].checked;
	  }
      }

      function sh_exchanges() {
          exchange = document.getElementById('exchange');
          if (exchange.style.display == "none" ) {
              exchange.style.display = "block";
          } else {
              exchange.style.display = "none";
          }
      }

      function draw_coins(path) {
	  // get coins
          var spawn = require('child_process').spawn,
              child = spawn(command, ["coins"], {cwd: path});

          child.stdout.on('data', function (data) {
	      cs = data.toString().replace(/123 |1st |456 |btc |eth |usdt /g,'').replace(/\n$/,'').split(" ")
	      // draw coins
              coin = document.getElementById('coins');
              coin_div = document.createElement('div');
              coin_html = ""
	      //cs = ["btc", "eth", "neo", "xmr", "eos"]
	      for (i in cs) {
                  coin_html +=  "<input type=\"checkbox\" name=\"coin\" value=\""+cs[i]+"\"> " + cs[i];
	      }
              coin_div.innerHTML = coin_html;
              coin.appendChild(coin_div);
          });
      }

      function toggle_coins() {
          coins = document.getElementById('coins');
          div = coins.children[0];
          for (i = 0; i < div.childElementCount; i++) {
              div.children[i].checked = !div.children[i].checked;
	  }
      }

      function sh_coins() {
          coins = document.getElementById('coins');
          if (coins.style.display == "none" ) {
              coins.style.display = "block";
          } else {
              coins.style.display = "none";
          }
      }

      function refresh() {
          path = ipcRenderer.sendSync('get-path')
          if ( process.platform === 'win32' ) {
              command = 'util';
          }  else if (process.platform === 'darwin') {
              command = './util';
          }

	  draw_exchanges(path)
	  draw_coins(path)
      }

      window.onload = refresh;

      function openCity(evt, cityName) {
          // Declare all variables
          var i, tabcontent, tablinks;
      
          // Get all elements with class="tabcontent" and hide them
          tabcontent = document.getElementsByClassName("tabcontent");
          for (i = 0; i < tabcontent.length; i++) {
              tabcontent[i].style.display = "none";
          }
      
          // Get all elements with class="tablinks" and remove the class "active"
          tablinks = document.getElementsByClassName("tablinks");
          for (i = 0; i < tablinks.length; i++) {
              tablinks[i].className = tablinks[i].className.replace(" active", "");
	      tablinks[i].style.display = "block"
          }
      
          // Show the current tab, and add an "active" class to the button that opened the tab
          document.getElementById(cityName).style.display = "block";
          evt.currentTarget.className += " active";
      }

      function displayTab() {
          // Declare all variables
          var i, tabcontent, tablinks;
      
          // Get all elements with class="tabcontent" and hide them
          tabcontent = document.getElementsByClassName("tabcontent");
          for (i = 0; i < tabcontent.length; i++) {
              tabcontent[i].style.display = "none";
          }
          tabcontent[0].style.display = "block";
      
          // Get all elements with class="tablinks" and remove the class "active"
          tablinks = document.getElementsByClassName("tablinks");
          for (i = 0; i < tablinks.length; i++) {
              tablinks[i].className = tablinks[i].className.replace(" active", "");
	      tablinks[i].style.display = "block"
          }
      }

      function hideTab() {
          // Declare all variables
          var i, tabcontent, tablinks;
      
          // Get all elements with class="tabcontent" and hide them
          tabcontent = document.getElementsByClassName("tabcontent");
          for (i = 0; i < tabcontent.length; i++) {
              tabcontent[i].style.display = "none";
          }
      
          // Get all elements with class="tablinks" and remove the class "active"
          tablinks = document.getElementsByClassName("tablinks");
          for (i = 0; i < tablinks.length; i++) {
              tablinks[i].className = tablinks[i].className.replace(" active", "");
	      tablinks[i].style.display = "none"
          }
      }
    </script>
  </body>
</html>
