<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>GapSeeker!</title>
  </head>
  <body>
    <h1>Help you find a gap.</h1>
            <strong> Target Exchange</strong> <input type="checkbox" onclick="toggle_exchanges()"\> Select All
    <br>
    <div id="exchange"> </div>
    <br>
            <strong>Target Coins </strong> <input type="checkbox" onclick="toggle_coins()"\> Select All
    <br>
    <div id="coins"> </div>
    <br>
    <form name="form3">
      <strong>Duration:</strong> <input type="text" id="duration" /> Hour <br>
      <strong>Minimum Gap:</strong> <input type="text" id="gap" /> % <br>
      <strong>Minimum Amount:</strong> <input type="text" id="amount" /> <br>
    </form>
    <button onclick="run()" class="fa fa-pencil-square-o" data-dismiss="alert">Run</button>
    <button onclick="stop()" class="fa fa-pencil-square-o" data-dismiss="alert">Stop</button>
    <div>
      <textarea id="output" cols="90" rows="10" class="form-control"></textarea>
    </div>

    <script>
      // You can also require other files to run in this process
      require('./renderer.js')
      const {ipcRenderer, clipboard} = require('electron')
      var child = null

      function run() {
          if (this.child != null) {
              document.getElementById("output").innerHTML += "Still running";
              return
          }

	  // get exchanges
	  ex_obj = document.getElementsByName("ex");
	  exs = []
	  for (k in ex_obj) {
	  if (ex_obj[k].checked) {
	      exs.push(ex_obj[k].value)
	  }
	  }

	  // get coins
	  coin_obj = document.getElementsByName("coin");
	  coins = []
	  for (k in coin_obj) {
	  if (coin_obj[k].checked) {
	      coins.push(coin_obj[k].value)
	  }
	  }

	  // get duration, gap, amount
	  duration = document.getElementById("duration");
	  gap = document.getElementById("gap");
	  amount = document.getElementById("amount");
	  if (duration.value.length == 0 || gap.value.length == 0 ||
		  amount.value.length == 0) {
              document.getElementById("output").innerHTML += "Please Specify Duration|Gap|Amount\n";
	      return;
	  }

          path = ipcRenderer.sendSync('get-path')
          if ( process.platform === 'win32' ) {
              command = 'find_gap';
          }  else if (process.platform === 'darwin') {
              command = './find_gap';
          }
          var spawn = require('child_process').spawn,
              child = spawn(command, ['run',exs.join(' '), coins.join(' '),
		      duration.value, gap.value, amount.value],
		      {cwd: path});

          document.getElementById("output").innerHTML = "Starting...\n";
          this.child = child;
          child.stdout.on('data', function (data) {
              document.getElementById("output").innerHTML += data;
          });
          child.stderr.on('data', function (data) {
              document.getElementById("output").innerHTML += data;
          });
          child.on('exit', function (data) {
              document.getElementById("output").innerHTML += "\nStopped";
              this.child = null;
          });
      }

      function stop() {
          if (child == null) {
              document.getElementById("output").innerHTML += "\nAlready Stopped";
          } else {
              child.kill();
              child = null;
          }
      }

      function draw_exchanges(path) {
	  // get exchanges
          var spawn = require('child_process').spawnSync,
              child = spawn(command, ["exchanges"], {cwd: path});

	  exs = child.stdout.toString().replace(/\n$/, '').split(" ")
	  console.log(exs)

	  // draw exchanges
          exchange = document.getElementById('exchange');
          ex_div = document.createElement('div');
          ex_html = ""
	  //exs = ["bigone", "binance", "bitfinex", "huobi", "okex"]
	  for (i in exs) {
              ex_html +=  "<input type=\"checkbox\" name=\"ex\" value=\""+exs[i]+"\"> " + exs[i];
	  }
          ex_div.innerHTML = ex_html
          exchange.appendChild(ex_div);
      }

      function toggle_exchanges() {
          exchange = document.getElementById('exchange');
          div = exchange.children[0];
          for (i = 0; i < div.childElementCount; i++) {
              div.children[i].checked = !div.children[i].checked;
	  }
      }

      function draw_coins(path) {
	  // get coins
          var spawn = require('child_process').spawn,
              child = spawn(command, ["coins"], {cwd: path});

          child.stdout.on('data', function (data) {
	      cs = data.toString().replace(/\n$/,'').split(" ")
	      // draw coins
              coin = document.getElementById('coins');
              coin_div = document.createElement('div');
              coin_html = ""
	      //cs = ["btc", "eth", "neo", "xmr", "eos"]
	      for (i in cs) {
                  coin_html +=  "<input type=\"checkbox\" name=\"coin\" value=\""+cs[i]+"\"> " + cs[i];
	      }
              coin_div.innerHTML = coin_html;
              coin.appendChild(coin_div);
          });
      }

      function toggle_coins() {
          exchange = document.getElementById('coins');
          div = exchange.children[0];
          for (i = 0; i < div.childElementCount; i++) {
              div.children[i].checked = !div.children[i].checked;
	  }
      }

      function refresh() {
          path = ipcRenderer.sendSync('get-path')
          if ( process.platform === 'win32' ) {
              command = 'util';
          }  else if (process.platform === 'darwin') {
              command = './util';
          }

	  draw_exchanges(path)
	  draw_coins(path)
      }

      window.onload = refresh;
    </script>
  </body>
</html>
